services:
  navidrome:
    container_name: navidrome
    restart: unless-stopped
    image: deluan/navidrome:0.58.0
    networks:
      - services
    environment:
      - "ND_SCANSCHEDULE=1h"
      - "ND_LOGLEVEL=info"
      - "ND_SESSIONTIMEOUT=24h"
      - "ND_ENABLESHARING=true"
      - "ND_LASTFM_ENABLED=true"
      - "ND_LASTFM_APIKEY=${ND_LASTFM_APIKEY}"
      - "ND_LASTFM_SECRET=${ND_LASTFM_SECRET}"
      - "ND_BACKUP_PATH=/backup"
      - "ND_BACKUP_SCHEDULE=*/5 0 * * *"
      - "ND_BACKUP_COUNT=7"
      - "ND_REVERSEPROXYWHITELIST=0.0.0.0/0"
      # Since authentication is entirely handled by Authelia, users don't need to
      # manage their password in Navidrome anymore.
      - "ND_ENABLEUSEREDITING=false"


    ports:
      - 8085:4533
    volumes:
      - "/mnt/containers/navidrome/backup:/backup"
      - "/mnt/containers/navidrome/data:/data"
      - "/mnt/containers/navidrome/collection:/music:ro"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.navidrome.entrypoints=websecure"
      - "traefik.http.services.navidrome.loadbalancer.server.port=4533"
      - "traefik.http.routers.navidrome.tls.certresolver=myresolver"
      - "traefik.http.routers.navidrome.middlewares=authelia@docker"
      - "traefik.http.routers.navidrome.rule=Host(`${HOST}`)"

      - "traefik.http.routers.navidrome-subsonic.tls.certresolver=myresolver"
      - "traefik.http.routers.navidrome-subsonic.rule=Host(`${HOST}`) && PathPrefix(`/rest/`) && !Query(`c`, `NavidromeUI`)"
      - "traefik.http.routers.navidrome-subsonic.entrypoints=websecure"
      - "traefik.http.routers.navidrome-subsonic.middlewares=authelia-basicauth@docker"
      - "homepage.group=Media streaming"
      - "homepage.name=Navidrome"
      - "homepage.icon=navidrome.svg"
      - "homepage.href=https://${HOST}"
      - "homepage.description=Music streaming"
networks:
  services:
    name: services
    external: true
